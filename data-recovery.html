<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据恢复助手 - 健身教练会员管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="./css/style.css">
</head>
<body class="bg-gray-50 min-h-screen p-6">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-lg p-8 mb-6">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">🔍 数据恢复助手</h1>
            
            <!-- 数据检查结果 -->
            <div id="checkResult" class="mb-6"></div>
            
            <!-- 操作按钮 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                <button onclick="checkData()" class="btn btn-primary">
                    <span>🔍</span>
                    <span>检查数据状态</span>
                </button>
                <button onclick="viewRawData()" class="btn btn-secondary">
                    <span>📄</span>
                    <span>查看原始数据</span>
                </button>
                <button onclick="exportBackup()" class="btn btn-secondary">
                    <span>💾</span>
                    <span>导出备份</span>
                </button>
                <button onclick="importBackup()" class="btn btn-secondary">
                    <span>📥</span>
                    <span>导入备份</span>
                </button>
            </div>

            <!-- 帮助信息 -->
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
                <h3 class="font-semibold text-blue-800 mb-2">💡 数据丢失可能的原因：</h3>
                <ul class="text-sm text-blue-700 space-y-1">
                    <li>• 清除了浏览器缓存或Cookie</li>
                    <li>• 使用了隐私/无痕浏览模式</li>
                    <li>• 更换了浏览器或设备</li>
                    <li>• 在数据管理中误点了"清空所有数据"</li>
                    <li>• 浏览器存储空间已满</li>
                </ul>
            </div>

            <!-- 解决方案 -->
            <div class="bg-green-50 border-l-4 border-green-400 p-4">
                <h3 class="font-semibold text-green-800 mb-2">✅ 解决方案：</h3>
                <ul class="text-sm text-green-700 space-y-1">
                    <li>1. 检查是否有之前导出的备份文件（.json格式）</li>
                    <li>2. 如果有备份，点击"导入备份"恢复数据</li>
                    <li>3. 如果没有备份，可以重新录入会员信息</li>
                    <li>4. 建议定期使用"导出备份"功能保存数据</li>
                </ul>
            </div>

            <!-- 返回按钮 -->
            <div class="mt-6 text-center">
                <a href="index.html" class="inline-block px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
                    ← 返回首页
                </a>
            </div>
        </div>
    </div>

    <!-- 隐藏的文件输入 -->
    <input type="file" id="importFileInput" accept=".json" style="display: none">

    <!-- 模态框容器 -->
    <div id="modalContainer"></div>

    <script src="./js/data.js"></script>
    <script>
        // 检查数据状态
        function checkData() {
            const members = DataManager.getMembers();
            const trainings = DataManager.getAllTrainingRecords();
            
            let html = '<div class="bg-white border-2 rounded-lg p-6">';
            html += '<h3 class="text-lg font-semibold mb-4">📊 数据状态报告</h3>';
            
            if (members.length > 0) {
                html += `
                    <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                        <p class="text-green-800 font-semibold">✅ 找到 ${members.length} 个会员记录</p>
                        <ul class="mt-2 text-sm text-green-700">
                            ${members.map(m => `<li>• ${m.name} - ${m.phone} (剩余课时: ${m.remainingCourses})</li>`).join('')}
                        </ul>
                    </div>
                `;
            } else {
                html += `
                    <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                        <p class="text-red-800 font-semibold">❌ 未找到会员记录</p>
                        <p class="text-sm text-red-600 mt-2">数据可能已丢失，请检查是否有备份文件</p>
                    </div>
                `;
            }
            
            if (trainings.length > 0) {
                html += `
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <p class="text-blue-800 font-semibold">✅ 找到 ${trainings.length} 条训练记录</p>
                    </div>
                `;
            } else {
                html += `
                    <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <p class="text-yellow-800 font-semibold">⚠️ 未找到训练记录</p>
                    </div>
                `;
            }
            
            // 显示存储空间使用情况
            const membersData = localStorage.getItem('fitnessMembers') || '';
            const trainingsData = localStorage.getItem('trainingRecords') || '';
            const totalSize = new Blob([membersData + trainingsData]).size;
            const sizeKB = (totalSize / 1024).toFixed(2);
            
            html += `
                <div class="mt-4 p-3 bg-gray-50 rounded">
                    <p class="text-sm text-gray-600">存储空间使用: ${sizeKB} KB</p>
                </div>
            `;
            
            html += '</div>';
            
            document.getElementById('checkResult').innerHTML = html;
        }

        // 查看原始数据
        function viewRawData() {
            const members = localStorage.getItem('fitnessMembers');
            const trainings = localStorage.getItem('trainingRecords');
            
            const html = `
                <div class="modal-overlay">
                    <div class="modal-content" style="max-width: 800px; max-height: 80vh;">
                        <div class="modal-header">
                            <h2 class="modal-title">📄 原始数据</h2>
                        </div>
                        <div class="modal-body" style="overflow-y: auto;">
                            <h3 class="font-semibold mb-2">会员数据 (fitnessMembers):</h3>
                            <pre class="bg-gray-100 p-3 rounded text-xs overflow-x-auto mb-4">${members || '(无数据)'}</pre>
                            
                            <h3 class="font-semibold mb-2">训练记录 (trainingRecords):</h3>
                            <pre class="bg-gray-100 p-3 rounded text-xs overflow-x-auto">${trainings || '(无数据)'}</pre>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">关闭</button>
                        </div>
                    </div>
                </div>
            `;
            showModal(html);
        }

        // 导出备份
        function exportBackup() {
            const members = DataManager.getMembers();
            const trainings = DataManager.getAllTrainingRecords();
            
            const backup = {
                exportDate: new Date().toISOString(),
                version: '1.0',
                members: members,
                trainings: trainings
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `backup-${new Date().toISOString().slice(0, 10)}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            alert('✅ 备份导出成功！请妥善保管备份文件。');
        }

        // 导入备份
        function importBackup() {
            document.getElementById('importFileInput').click();
        }

        // 初始化文件输入
        document.getElementById('importFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const backup = JSON.parse(event.target.result);
                    
                    if (!backup.members || !backup.trainings) {
                        alert('❌ 备份文件格式错误！');
                        return;
                    }
                    
                    if (confirm(`确定要导入备份吗？

将导入：
• ${backup.members.length} 个会员
• ${backup.trainings.length} 条训练记录

⚠️ 这将覆盖当前数据！`)) {
                        localStorage.setItem('fitnessMembers', JSON.stringify(backup.members));
                        localStorage.setItem('trainingRecords', JSON.stringify(backup.trainings));
                        
                        alert('✅ 数据恢复成功！');
                        checkData();
                    }
                } catch (error) {
                    alert('❌ 文件解析失败：' + error.message);
                }
            };
            reader.readAsText(file);
            
            e.target.value = '';
        });

        // 显示模态框
        function showModal(html) {
            document.getElementById('modalContainer').innerHTML = html;
        }

        // 关闭模态框
        function closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
        }

        // 页面加载时自动检查
        window.addEventListener('DOMContentLoaded', checkData);
    </script>
</body>
</html>
